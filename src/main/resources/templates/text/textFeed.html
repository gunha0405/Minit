<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<script defer src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="/css/text/textFeedStyle.css" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.24/dist/sweetalert2.min.css">
<title>텍스트 피드</title>
</head>
<body>
    <th:block th:include="/common/header"></th:block>
    <div class="wrapper">
    <!-- 유저가 로그인했는지 안했는지 확인하기 위한 코드 -->
    <input type="hidden" id="currentUser" th:value="${session.user != null ? 'true' : 'false'}"/> 
        <section class="text-feed">
            <div th:if="${session.user != null}" class="text-feed-write-box">
                
                <div class="text-feed-write-area">
                    <!-- form 태그 대신 비동기 방식으로 글 작성 -->
                        <textarea name="text-feed-content" id="text-feed-content" placeholder="오늘 무슨일이 있었나요?(100자)"></textarea>
                        <div class="text-feed-actions">
                            <button  type="submit" class="text-feed-button write-btn">작성하기</button>
                        </div>
                    
                </div>
            </div>
            
            <div class="text-feed-posts" id="text-feed-posts">
	                <div class="post" th:each="textFeed : ${textFeedList}">
	                
	                	<span class="textFeedNo" th:text="${textFeed.textFeedNo}" style="display:none;"></span>
	                    <div class="post-profile-pic">
	                        <img src="Profile Picture" alt="Profile Picture">
	                    </div>
	                    <div class="post-content">
	                        <p class="text-feed-writer" th:text="${textFeed.textFeedWriter}"></p>
	                        <p class="text-feed-content" th:text="${textFeed.textFeedContent}"></p>
	                        <div class="post-actions">
	                            <i class="fa fa-heart"></i>
	                            <i class="fa fa-paper-plane"></i>
	                            <i class="fa fa-comment"></i>
	                            <span>댓글수</span>
	                            <i class="fa fa-ellipsis-h"></i>
	                            <div class="post-options">
	                                <button th:if="${session.user != null} and ${session.user.userId} == ${textFeed.textFeedWriter}"><span class="material-icons edit-btn">edit</span></button>
	                                <button><span class="material-icons report-btn">report_problem</span></button>
	                                <button><span class="material-icons bookmark-btn">bookmark_border</span></button>
	                                <button th:if="${session.user != null} and ${session.user.userId} == ${textFeed.textFeedWriter}"><span class="material-icons delete-btn">delete_forever</span></button>
	                        </div>
	                    </div>
	                    
	                    
	                    <div th:if="${session.user != null}" class="comment-section">
	                        <textarea  placeholder="댓글을 작성해보세요 !"></textarea>
	                        <button class="submit-comment">댓글 달기</button>
	                        <div class="comments-container">
							    <div class="comment" th:each="comment : ${textFeed.textFeedCommentList}">
							        <div class="comment-profile-pic">
							            <img src="Profile Picture" alt="Profile Picture">
							        </div>
							        <div class="comment-content">
							            <p class="comment-author" th:text="${comment.textFeedCommentWriter}"></p>
							            <p class="comment-text" th:text="${comment.textFeedCommentContent}"></p>
							            <div class="comment-actions">
							                <i class="fa fa-heart"></i>
							            </div>
							        </div>
							        <div class="comment-options">
							            <button><span class="material-icons report-btn">report_problem</span></button>
							            <button th:if="${session.user != null} and ${session.user.userId} == ${comment.textFeedCommentWriter}"><span class="material-icons comment-delete-btn">delete_forever</span></button>
							        </div>
							    </div>
							</div>

	                </div>
	            </div>
            </div>
            <button th:if="${session.user != null}" id="load-more" class="text-feed-button">더보기</button>
            <button th:if="${session.user == null}" id="login-load-more" class="text-feed-button">
            <a
           		class="nav-link"
                aria-current="page"
                href="/text/textList"
                data-bs-toggle="modal"
                data-bs-target="#loginModal"
                >로그인 후 더보기</a></button>
                
        </section>
    </div>
    
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.24/dist/sweetalert2.min.js"></script>
    <script>
    
    $(document).ready(function() {
        let posts = $('#text-feed-posts .post');
        let numPerPage = 3;
        let currentPage = 1;

        function showPage(page) {
            let start = (page - 1) * numPerPage;
            let end = page * numPerPage;
            posts.slice(start, end).show();
        }

        // 초기 로드 시 첫 번째 페이지를 표시
        showPage(currentPage);

        $('#load-more').click(function() {
            currentPage++;
            showPage(currentPage);
        });

        // 모든 포스트를 숨기고 처음 numPerPage개의 포스트만 표시
        posts.hide();
        showPage(currentPage);

        function adjustPostOptionsDimensions() {
            $('.post-options').each(function() {
                const visibleButtons = $(this).find('button:visible').length;
                const buttonHeight = 30; // 각 버튼의 높이 (px 단위로 지정)
                const buttonWidth = 30; // 버튼의 너비 (px 단위로 지정)
                const newHeight = visibleButtons * buttonHeight;
                $(this).css('height', newHeight + 'px');
                $(this).css('width', buttonWidth + 'px');
            });
        }

        function bindPostEvents(postElement) {
            postElement.find(".fa-ellipsis-h").click(function() {
                const postOptions = $(this).siblings(".post-options");
                postOptions.toggle();
                adjustPostOptionsDimensions();
            });

            postElement.find(".delete-btn").click(function() {
                const textFeedElement = $(this).closest(".post");
                const textFeedNo = textFeedElement.find(".textFeedNo").text();
                
                $.ajax({
                    url: "/text/deleteTextFeed",
                    type: "get",
                    data: { textFeedNo: textFeedNo },
                    dataType: "json",
                    success: function(result) {
                        if (result === 1) {
                        	Swal.fire({
	                            title : "삭제 성공",
	                            text : "피드 삭제 성공",
	                            icon : "success"
	                        });
                            textFeedElement.remove();
                        } else {
                        	Swal.fire({
	                            title : "삭제 실패",
	                            text : "문제가 발생했습니다. 잠시 후 다시 시도해주세요.",
	                            icon : "warning"
	                        });
                        }
                    },
                    error: function() {
                        console.log("서버 전송 실패");
                    }
                });
            });
        }

        // 초기 조정
        adjustPostOptionsDimensions();

        // 페이지 로드 시 기존 포스트에 이벤트 바인딩
        bindPostEvents($(".post"));

        $(".write-btn").on("click", function() {
            const textFeedContent = $("#text-feed-content").val();
            $.ajax({
                url: "/text/textFeedWrite",
                type: "get",
                data: { textFeedContent: textFeedContent },
                dataType: "json",
                success: function(data) {
                    console.log(data);
                    const newPost = data.textFeed;
                    const user = data.user;
                    const postHtml = `
                        <div class="post">
                            <span class="textFeedNo" style="display:none;">${newPost.textFeedNo}</span>
                            <div class="post-profile-pic">
                                <img src="Profile Picture" alt="Profile Picture">
                            </div>
                            <div class="post-content">
                                <p class="text-feed-writer">${newPost.textFeedWriter}</p>
                                <p class="text-feed-content">${newPost.textFeedContent}</p>
                                <div class="post-actions">
                                    <i class="fa fa-heart"></i>
                                    <i class="fa fa-paper-plane"></i>
                                    <i class="fa fa-comment"></i>
                                    <span>댓글수</span>
                                    <i class="fa fa-ellipsis-h"></i>
                                    <div class="post-options">
                                        <button><span class="material-icons edit-btn">edit</span></button>
                                        <button><span class="material-icons report-btn">report_problem</span></button>
                                        <button><span class="material-icons bookmark-btn">bookmark_border</span></button>
                                        <button><span class="material-icons delete-btn">delete_forever</span></button>
                                    </div>
                                </div>
                            </div>
                            <div class="comment-section">
                                <textarea placeholder="댓글을 작성해보세요 !"></textarea>
                                <button class="submit-comment">댓글 달기</button>
                                <div class="comments-container">
                                
                                </div>
                            </div>
                        </div>
                    `;

                    const newPostElement = $(postHtml);
                    $("#text-feed-posts").prepend(newPostElement);
                    $("#text-feed-content").val("");
                    
                    // 새로 추가된 요소들에 이벤트 바인딩
                    bindPostEvents(newPostElement);
                },
                error: function() {
                    console.log("서버연결 실패");
                    alert("글 작성 실패");
                }
            });
        });//글 작성
        
        const isLoggedIn = $('#currentUser').val() === 'true';

        if (isLoggedIn) {
            $(".fa-comment").click(function() {
                $(this).closest(".post").find(".comment-section").toggle();
            });
        }else{
        	$(".fa-comment").click(function(){
        		Swal.fire({
                    title : "",
                    text : "댓글은 로그인 후 볼 수 있어요!",
                    icon : "warning"
                });	
        	})
        	
        }
	
        $(".submit-comment").click(function() {
            const textFeedCommentContent = $(this).siblings("textarea").val();
            const textFeedElement = $(this).closest(".post"); 
            const textFeedNo = textFeedElement.find(".textFeedNo").text();
            $.ajax({
            	url : "/text/textFeedCommentWrite",
            	type : "get",
            	data : {textFeedCommentContent : textFeedCommentContent,
            			textFeedNo : textFeedNo},
            	dataType : "json",
            	success : function(data){
            		const comment = data.textFeedComment;
                    const user = data.commentWriterUser;
                    const commentHtml = `
                        <div class="comment">
                            <div class="comment-profile-pic">
                                <img src="user.profilePic" alt="Profile Picture">
                            </div>
                            <div class="comment-content">
                                <p class="comment-author">${comment.textFeedCommentWriter}</p>
                                <p class="comment-text">${comment.textFeedCommentContent}</p>
                                <div class="comment-actions">
                                    <i class="fa fa-heart"></i>
                                </div>
                            </div>
                            <div class="comment-options">
                                <button><span class="material-icons report-btn">report_problem</span></button>
                                <button><span class="material-icons delete-btn">delete_forever</span></button>
                            </div>
                        </div>
                    `;
                    textFeedElement.find(".comments-container").append(commentHtml);
                    textFeedElement.find("textarea").val(""); // 댓글 입력창 비우기
            	},
            	error : function(){
            		console.log("데이터 전송 실패");
            		
            	}
            })
            
          
        });    
        
        
        
    });
    
	
</script>
<th:block th:include="/common/footer"></th:block>
</body>
</html>