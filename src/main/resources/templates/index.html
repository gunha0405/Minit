<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Minit 프로젝트</title>
<link rel="stylesheet" href="/css/style.css">
<style>
.post {
    width: 400px; 
    margin: 20px auto; 
    border: 1px solid #ddd; 
    border-radius: 8px; 
   	overflow : hidden; 
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
    background-color: #fff; 
}
.post-image-container {
    width: 100%;
    height: auto;
    max-height: 300px;
    overflow: hidden;
    position: relative;
}

.post-image {
    width: 80%;
    height: auto;
    max-height: 300px;
    object-fit: none;
    display: block;
}
.post-meta-link {
	text-decoration: none;
	color : black;
}
.contents-box{
	display:inline flex;
	justify-content: space-around;
	margin : 20px;
}
.main-contents{
	margin : 30px;
}
.btn btn-primary{
	text-align: center;
	
}


</style>
</head>
<body>
<th:block th:include="common/header"></th:block>
    <div class="wrapper">
      <!--회원가입 모달창-->
      <div
        class="modal fade"
        id="loginModal"
        tabindex="-1"
        aria-labelledby="loginModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="loginModallabvel">로그인</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <form>
                <div class="mb-3">
                  <label for="email" class="form-label">아이디</label>
                  <input
                    type="text"
                    class="form-control"
                    id="email"
                    placeholder="name@example.com"
                  />
                </div>
                <div class="mb-3">
                  <label for="password" class="form-label">비밀번호</label>
                  <input
                    type="password"
                    class="form-control"
                    id="password"
                    placeholder="비밀번호"
                  />
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                닫기
              </button>
              <button type="button" class="btn btn-primary">로그인</button>
            </div>
          </div>
        </div>
      </div>   
      <!--메인 컨텐츠 시작 -->
      <div class ="contents-box">
      
      <div class="sub1-contents">
        <a href ="javascript:void(0)" id="board">전체게시판</a>
        <a href="javascript:void(0)" id="best">인기게시판</a>
        <a href="javascript:void(0)" id="following">친구게시판</a>
      </div>
     
    
    <section>
    
    
        <div class="contents">
          <div class="main-contents">
            <p class="board-write">전체게시판</p>           
            <div class="main-contents-box" id="postContainer">
              <article class="post">
                <div class="post-header">     
                  <p class="post-meta"></p>
                </div>
                <img src="" alt="게시글 이미지" class="post-image">
                <p class="post-content"></p>
                <div class="post-footer">
                  <span class="post-comment"></span>
                  <span class="post-stat"></span>
                </div>
              </article>
              </div>
             </div>
      			<div id="postContainer"></div>
					<button id="loadMoreButton">더보기</button>
            </div>
      </section>
     
     
        
      <div class="sub2-contents">
        <a href="#">이자리는 광고가 들어올예정입니다.</a>
      </div>
      <div class="photoUpload">
        <ul class="nav">
          <li class="nav-item">
            <a class="uploadItem" aria-current="page" href="#">+</a>
          </li>
        </ul>
      </div>
    </div>
      </div>
   
    <!--밑에 네비게이션 바-->
    
	
	
	<th:block th:include="common/footer"></th:block>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

 

 <script th:inline="javascript">
 $(document).ready(function() {
	    let offset = 0;
	    const limit = 5;
	    let allPostsLoaded = false;
	    let isLoggedIn = false;

	    function checkLoginStatus(callback) {
	        $.ajax({
	            url: "/home/user/checkLoginStatus",
	            type: "GET",
	            success: function(isLoggedInResponse) {
	                isLoggedIn = isLoggedInResponse;
	                if (isLoggedIn) {
	                    callback();
	                } else {
	                    $('#loginModal').modal('show');
	                }
	            },
	            error: function(xhr, status, error) {
	                console.log("로그인 상태 확인 오류: " + error);
	                Swal.fire({
	                    title: "오류",
	                    text: "로그인 상태를 확인하는 중 오류가 발생했습니다.",
	                    icon: "error"
	                });
	            }
	        });
	    }

	    function loadPosts() {
	        if (allPostsLoaded) return;

	        console.log('Loading posts with offset:', offset); // 데이터 로드 확인

	        $.ajax({
	            url: '/index',
	            method: 'GET',
	            dataType: 'json',
	            data: { offset: offset, limit: limit },
	            success: function(data) {
	                console.log('Data loaded:', data); // 데이터 확인

	                const combinedList = [...data.photolist, ...data.feedlist];
	                const limitedList = combinedList.slice(0, limit);

	                if (limitedList.length < limit) {
	                    allPostsLoaded = true;
	                }

	                limitedList.forEach(b => {
	                    const userFeedWriter = b.userFeedWriter || b.photoFeedWriter;
	                    const writerLink = `/feed/myPage?userFeedWriter=${encodeURIComponent(userFeedWriter)}`;
	                    const imageLink = "/photo/list";

	                    const postHtml = `
	                    <article class="post">
	                        <div class="post-header">
	                            <a href="${writerLink}" class="post-meta-link">
	                                ${b.photoFeedWriter || b.userFeedWriter} ${b.regDate || b.createDate}
	                            </a>
	                        </div>
	                        <div class="post-image-container">
	                            <a href="${imageLink}" class="post-image-link">
	                                <img src="/photo/${b.photoFeedImg || b.userFeedFilepath}" alt="이미지" class="post-image">
	                            </a>
	                        </div>
	                    </article>`;

	                    $('#postContainer').append(postHtml);
	                });

	                offset += limit;
	                $(".board-write").text("전체게시판");

	                console.log('Posts loaded and offset updated:', offset); // Offset 확인
	            },
	            error: function(xhr, status, error) {
	                console.error('AJAX 요청 오류:', status, error);
	            }
	        });
	    }

	    $('#loginButton').click(function() {
	        const email = $('#email').val();
	        const password = $('#password').val();

	        $.ajax({
	            url: '/login',
	            method: 'POST',
	            data: {
	                email: email,
	                password: password
	            },
	            success: function(response) {
	                if (response.success) {
	                    $('#loginModal').modal('hide');
	                    isLoggedIn = true;
	                    loadPosts(); 
	                } else {
	                    Swal.fire({
	                        title: "로그인 실패",
	                        text: response.message || "로그인에 실패했습니다.",
	                        icon: "error"
	                    });
	                }
	            },
	            error: function(xhr, status, error) {
	                console.error('로그인 요청 오류:', status, error);
	            }
	        });
	    });

	    // ‘더보기’ 버튼 클릭 시 추가 데이터 로드
	    $('#loadMoreButton').click(function() {
	        console.log('Load more button clicked'); // 버튼 클릭 확인
	        if (!allPostsLoaded) {
	            loadPosts();
	        }
	    });

	    // 전체 게시판 버튼 클릭 시 초기화 및 데이터 로드
	    $('#board').click(function() {
	        checkLoginStatus(function() {
	            offset = 0;
	            allPostsLoaded = false;
	            $('#postContainer').empty(); // 게시물 초기화
	            loadPosts();
	        });
	    });

	    // 로그인 모달 열기 버튼 클릭 시 초기화 및 데이터 로드
	    $('#showLoginModal').click(function() {
	        checkLoginStatus(function() {
	            offset = 0;
	            allPostsLoaded = false;
	            $('#postContainer').empty(); // 게시물 초기화
	            loadPosts();
	        });
	    });
	

	


	    // 인기게시판 클릭 시 게시물 로드
	    $('#best').click(function() {
	        $.ajax({
	            url: '/best',
	            method: 'GET',
	            dataType: 'json',
	            success: function(list) {
	                $('#postContainer').empty(); // 기존 콘텐츠를 비움

	                list.forEach(b => {
	                    const writerLink = `/feed/myPage?userFeedWriter=${encodeURIComponent(b.photoFeedWriter)}`;
	                    const imageLink = "/photo/list";

	                    let postHtml = `
	                    <article class="post">
	                        <div class="post-header">
	                            <a href="${writerLink}" class="post-meta-link">
	                                ${b.photoFeedWriter} ${b.regDate}
	                            </a>
	                        </div>
	                        <div class="post-image-container">
	                            <a href="${imageLink}" class="post-image-link">
	                                <img src="/photo/${b.photoFeedImg}" alt="이미지" class="post-image">
	                            </a>
	                        </div>
	                        <div class="post-footer">
	                            <span class="post-comment">좋아요 ${b.totalLikes}</span>
	                        </div>
	                    </article>`;

	                    $('#postContainer').append(postHtml);
	                });

	                $(".board-write").text("인기게시판");
	            },
	            error: function() {
	                console.log("서버 실패");
	            }
	        });
	    });

	    // 친구게시판 클릭 시 게시물 로드
	    $('#following').click(function() {
	        $.ajax({
	            url: '/following',
	            method: 'GET',
	            dataType: 'json',
	            success: function(list) {
	                $('#postContainer').empty(); // 기존 콘텐츠를 비움

	                list.forEach(b => {
	                    const writerLink = `/feed/myPage?userFeedWriter=${encodeURIComponent(b.userFeedWriter)}`;
	                    const imageLink = "/photo/list";

	                    let postHtml = `
	                    <article class="post">
	                        <div class="post-header">
	                            <a href="${writerLink}" class="post-meta-link">
	                                ${b.userFeedWriter} ${b.userFeedDate}
	                            </a>
	                        </div>
	                        <div class="post-image-container">
	                            <a href="${imageLink}" class="post-image-link">
	                                <img src="/photo/${b.photoFeedImg}" alt="이미지" class="post-image">
	                            </a>
	                            <span class="post-content">${b.userFeedContent}</span>
	                        </div>
	                        
	                        </div>
	                    </article>`;

	                    $('#postContainer').append(postHtml);
	                });

	                $(".board-write").text("친구게시판");
	            },
	            error: function() {
	                console.log("서버 실패");
	            }
	        });
	    });

	    // 검색 버튼 클릭 시 게시물 로드
	    $('#searchButton').click(function() {
	        let userId = $("#searchList").val();
	        console.log("search" + userId);

	        $.ajax({
	            url: '/searchList',
	            method: 'GET',
	            data: { userId: userId },
	            dataType: 'json',
	            success: function(list) {
	                $('#postContainer').empty(); // 기존 콘텐츠를 비움

	                const combinedList = [...list.photolist, ...list.feedlist];

	                if (combinedList.length === 0) {
	                    $('#postContainer').html('<h1>검색결과x</h1>');
	                } else {
	                    combinedList.forEach(b => {
	                        const writerLink = `/feed/myPage?userFeedWriter=${encodeURIComponent(b.photoFeedWriter || b.userFeedWriter)}`;
	                        const imageLink = "/photo/list";

	                        let postHtml = `
	                        <article class="post">
	                            <div class="post-header">
	                                <a href="${writerLink}" class="post-meta-link">
	                                    ${b.photoFeedWriter || b.userFeedWriter} ${b.regDate || b.createDate}
	                                </a>
	                            </div>
	                            <div class="post-image-container">
	                                <a href="${imageLink}" class="post-image-link">
	                                    <img src="/photo/${b.photoFeedImg || b.userFeedFilepath}" alt="이미지" class="post-image">
	                                </a>
	                            </div>
	                        </article>`;

	                        $('#postContainer').append(postHtml);
	                    });
	                }

	                $(".board-write").text("검색결과");
	            },
	            error: function(xhr, status, error) {
	                console.error('AJAX 요청 오류:', status, error);
	                $('#postContainer').html('<h1>똑바로 검색 하쇼</h1>');
	                $(".board-write").text("검색결과");
	            }
	        });
	    });

	    // 초기 게시물 로딩
	    loadPosts();
	});
 
 
 
 /*
 function checkLoginStatus(callback) {
     $.ajax({
       url: "/home/user/checkLoginStatus",
       type: "GET",
       success: function(isLoggedIn) {
         if (isLoggedIn) {
           callback();
         } else {
           Swal.fire({
             title: "로그인 필요",
             text: "로그인 후 이용해 주세요",
             icon: "info"
           });
         }
       },
       error: function(xhr, status, error) {
         console.log("로그인 상태 확인 오류: " + error);
         Swal.fire({
           title: "오류",
           text: "로그인 상태를 확인하는 중 오류가 발생했습니다.",
           icon: "error"
         });
       }
     });
   }
*/



 
    </script>
 
  
    </body>
</html>